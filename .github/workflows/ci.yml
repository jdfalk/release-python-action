# file: .github/workflows/ci.yml
# version: 1.1.0
# guid: c9d0e1f2-a3b4-5678-c234-789012345678

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  validate:
    name: Validate Action
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Validate action.yml
        run: |
          if [ ! -f action.yml ]; then
            echo "Error: action.yml not found"
            exit 1
          fi
          echo "âœ… action.yml validation passed"

  test:
    name: Test Action
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11', '3.12', '3.13']
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
        with:
          python-version: ${{ matrix.python-version }}

      - name: Create test project
        run: |
          mkdir -p test-project
          cd test-project
          cat > setup.py << 'EOF'
          from setuptools import setup

          setup(
              name='test-package',
              version='1.0.0',
              packages=['test_package'],
          )
          EOF

          mkdir test_package
          cat > test_package/__init__.py << 'EOF'
          __version__ = '1.0.0'
          EOF

      - name: Test action execution
        uses: ./
        with:
          python-version: '${{ matrix.python-version }}'
          package-dir: './test-project'
          build-backend: 'setuptools'
          run-tests: 'false'
          pypi-token: 'fake-token-for-testing'
          skip-existing: 'true'

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Run yamllint
        uses: ibiqlik/action-yamllint@2576378a8e339169678f9939646ee3ee325e845c # v3.1.1
        with:
          file_or_dir: action.yml
          config_data: |
            extends: default
            rules:
              line-length:
                max: 120
                level: warning
              document-start: disable
